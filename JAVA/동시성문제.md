# ë™ì‹œì„± ë¬¸ì œ

# ë™ì‹œì„± ë¬¸ì œ

## Concurrently vs Simultaneously

***concurrently: overlapping in duration***

***simultaneously: at the same instant***

![Untitled](https://user-images.githubusercontent.com/61227459/179383587-d4389f77-3152-4e02-a5d0-92393e9cdc2b.png)

- Case 1
    - concurrently O, simultaneously X
    - ë¨¼ì € ì‹œì‘ëœ task ê°€ ëë‚˜ì§€ ì•Šì•„ë„ ë‹¤ë¥¸ task ë¥¼ ì‹œì‘ (concurrently)
    - ë¬¼ë¦¬ì ìœ¼ë¡œ ì •í™•íˆ ê°™ì€ ì‹œê°„ëŒ€ì— ë™ì‹œì— ìˆ˜í–‰ë˜ëŠ” ê²ƒì€ ì•„ë‹˜ (simultaneously)
- Case 2
    - concurrently O, simultaneously O
    - ë¨¼ì € ì‹œì‘ëœ task ê°€ ëë‚˜ì§€ ì•Šì•„ë„ ë˜ ë‹¤ë¥¸ task ë¥¼ ì‹œì‘ (concurrently)
    - ê°™ì€ ì‹œê°„ëŒ€ì— ê° task ê°€ ë™ì‹œì— ìˆ˜í–‰ (simultaneously)
- **ë™ì‹œì„±ì€ ë³‘ë ¬ì„±ì´ê¸° ìœ„í•œ í•„ìš”ì¡°ê±´ì´ì§€ë§Œ ì¶©ë¶„ì¡°ê±´ì€ ì•„ë‹ˆë‹¤**
    
    ë³‘ë ¬ì„± O â†’ ë™ì‹œì„± O
    
    ë™ì‹œì„± O â†’ ë³‘ë ¬ì„± X
    

## ë™ì‹œì„± vs ë³‘ë ¬ì„±

- ë™ì‹œì„± (Concurrency)
    - ì—¬ëŸ¬ ê³„ì‚°ì´Â **ë™ì‹œì—** ì‹¤í–‰ (í•˜ëŠ” ê²ƒì²˜ëŸ¼ ë³´ì„)
    - ì‹±ê¸€ ì½”ì–´ì—ì„œ ë©€í‹° ì“°ë ˆë“œë¥¼ ë™ì‘
    - Context switchê°€ ì¼ì–´ë‚¨
- ë³‘ë ¬ì„± (Parallelism)
    - ë§ì€ ê³„ì‚° ë˜ëŠ” í”„ë¡œì„¸ìŠ¤ ì‹¤í–‰ì´Â **ë™ì‹œì—**Â ìˆ˜í–‰
    - ë©€í‹° ì½”ì–´ì—ì„œ ë©€í‹° ì“°ë ˆë“œë¥¼ ë™ì‘
    
![Untitled 1](https://user-images.githubusercontent.com/61227459/179383578-4b3e9420-9b1b-4413-85c8-40f049ace4e7.png)

## ë¬¸ì œ

> ë‘ ê°œ ì´ìƒì˜ ì„¸ì…˜ì´ ê³µí†µëœ ìì›ì— ëŒ€í•´ ëª¨ë‘Â **ì½ê³  ì“°ëŠ” ì‘ì—…(Readâ†’Write)**Â ì„ í•˜ë ¤ê³  í•˜ëŠ” ê²½ìš° ë°œìƒí•  ìˆ˜ ìˆëŠ” ë¬¸ì œ
> 

> â€œì¼ê´€ì„± ì—†ëŠ” ì½ê¸°â€ 
â€œì†ì‹¤ë˜ëŠ” ì—…ë°ì´íŠ¸â€
>

![Untitled 2](https://user-images.githubusercontent.com/61227459/179383583-b1efe4f0-14f9-48dc-a55f-8f747db29758.png)
![Untitled 3](https://user-images.githubusercontent.com/61227459/179383585-7cab06b5-2f04-4054-87e2-501c206c40ab.png)
# ë™ì‹œì„± ë¬¸ì œ ì˜ˆì‹œ ë° ê²°ê³¼

## ë¬¸ì œ

```java
private static long count = 0;

@Test
void threadNotSafe() throws Exception {
    int maxCnt = 10;

    for (int i = 0; i < maxCnt; i++) {
        new Thread(() -> {
            count++;
            System.out.println(count);
        }).start();
    }

    Thread.sleep(100); // ëª¨ë“  ì“°ë ˆë“œê°€ ì¢…ë£Œë  ë•Œê¹Œì§€ ì ê¹ ëŒ€ê¸°
    Assertions.assertThat(count).isEqualTo(maxCnt);
}
```

## ê²°ê³¼

- `count++`Â ì—°ì‚°ì´Â **ì›ìì„±ì„ ë³´ì¥í•˜ì§€ ì•Šê¸° ë•Œë¬¸ì—**Â ì•„ë˜ì™€ ê°™ì´ í…ŒìŠ¤íŠ¸ì— ì‹¤íŒ¨

![Untitled 4](https://user-images.githubusercontent.com/61227459/179383586-fd92b81e-eb4a-4963-a946-7a3fb3562e90.png)

# í•´ê²°ë²•

## Synchronized

- í•´ë‹¹ ë¸”ëŸ­ì˜ ì•¡ì„¸ìŠ¤ë¥¼ ë™ê¸°í™” â†’ ë™ì‹œì— í•˜ë‚˜ì˜ ìŠ¤ë ˆë“œë§Œ ì ‘ê·¼ ê°€ëŠ¥

```java
// ì˜ˆì œ
public class SomeClass {
    // ë©”ì„œë“œ ì „ì²´ì— ë™ê¸°í™” ì ìš©
    public synchronized void foo() { 
        /* critical section */
    }

    // ë‚´ë¶€ì— ë™ê¸°í™” ë¸”ëŸ­ ìƒì„±
    public void bar() {
        synchronized (this) {
            /* critical section */
        }
    }
}

// í´ë˜ìŠ¤ ë‚´ë¶€ì˜ ì „ì—­ ë©”ì„œë“œì—ì„œ ë™ê¸°í™” ë¸”ëŸ­ì„ ìƒì„±í•˜ëŠ” ë°©ë²•
public class SomeClass {
    public static void syncMethod() {
        synchronized (SomeClass.class) {
            /* critical section */
        }
    }
}
```

```java
// ì ìš©
private static long count = 0;

@Test
void threadNotSafe() throws Exception {
    int maxCnt = 10;

    for (int i = 0; i < maxCnt; i++) {
        new Thread(this::plus).start();
    }

    Thread.sleep(100); // ëª¨ë“  ìŠ¤ë ˆë“œê°€ ì¢…ë£Œë  ë•Œê¹Œì§€ ì ê¹ ëŒ€ê¸°
    Assertions.assertThat(count).isEqualTo(maxCnt);
}

// synchronizedìœ¼ë¡œ count++
public synchronized void plus() { // synchronized í‚¤ì›Œë“œ ì‚¬ìš©
    count++;
}
```

ë‹¨ì 

- íŠ¹ì • ì“°ë ˆë“œëŠ”Â `synchronized`Â ë©”ì„œë“œì— ì ‘ê·¼ ì‹œ ë¸”ë¡ ì „ì²´ì— lock
- í•´ë‹¹ ì“°ë ˆë“œê°€ ë¸”ëŸ­ì„ ë¹ ì ¸ë‚˜ê°€ê¸° ì „ê¹Œì§€ ë‹¤ë¥¸ ì“°ë ˆë“œë“¤ì€ ë™ê¸°í™” ì²˜ë¦¬ëœ ë¸”ë¡ì— ì ‘ê·¼ X
- ë‹¤ë¥¸ ì“°ë ˆë“œë“¤ì€ ì•„ë¬´ëŸ° ì‘ì—…ì„ í•˜ì§€ ëª»í•˜ê³  ê¸°ë‹¤ë¦¼ = ìì› ë‚­ë¹„
- critical section(ê³µìœ ë³€ìˆ˜ ì˜ì—­)ì˜ í¬ê¸° ë° ì‹¤í–‰ì‹œê°„ì— ë”°ë¼ ì„±ëŠ¥í•˜ë½ ë° ìì›ë‚­ë¹„ê°€ ë§¤ìš° ì‹¬í•¨
    - ê³µìœ ë³€ìˆ˜ ì˜ì—­: ë³‘ë ¬ì»´í“¨íŒ…ì—ì„œ ë‘˜ ì´ìƒì˜ ì“°ë ˆë“œê°€ ë™ì‹œì— ì ‘ê·¼í•´ì„œëŠ” ì•ˆë˜ëŠ” ê³µìœ  ìì›ì„ ì ‘ê·¼í•˜ëŠ” ì½”ë“œì˜ ì¼ë¶€

## Volatile

[Volatile](Volatile.md)

- JVMì—ì„œ ì“°ë ˆë“œëŠ” ì‹¤í–‰ë˜ê³  ìˆëŠ” CPU ë©”ëª¨ë¦¬ ì˜ì—­ì— ë°ì´í„°ë¥¼ ìºì‹±
- ë©€í‹°ì½”ì–´ í”„ë¡œì„¸ì„œì—ì„œ ë‹¤ìˆ˜ì˜ ì“°ë ˆë“œê°€ ë³€ìˆ˜ aë¥¼ ê³µìœ  â†’ ìºì‹± ëœ ì‹œì ì— ë”°ë¼ ë°ì´í„°ê°€ ë‹¤ë¥¼ ìˆ˜ ìˆìŒ
    - ì„œë¡œ ë‹¤ë¥¸ ì½”ì–´ì˜ ì“°ë ˆë“œëŠ” ë°ì´í„° ê°’ì´ ë¶ˆì¼ì¹˜
- ì„ì˜ë¡œ ë°ì´í„°ë¥¼ ê°±ì‹ í•´ ì£¼ì§€ ì•ŠëŠ” ì´ìƒÂ **ìºì‹± ëœ ë°ì´í„°ê°€ ì–¸ì œ ê°±ì‹  ë˜ëŠ”ì§€  ì•Œ ìˆ˜ ì—†ìŒ**

> ì›ìì„±ì´ ë³´ì¥ë˜ì§€ ì•Šìœ¼ë©´ ë™ì‹œì„± ë¬¸ì œ ë°œìƒ
> 

## Atomic class

### AtomicLong

```java
java.util.concurrent.atomic.AtomicInteger
```

- Thread-safeë¡œ êµ¬í˜„ë˜ì–´ ë©€í‹°ì“°ë ˆë“œì—ì„œ synchronized ì—†ì´ ì‚¬ìš© ê°€ëŠ¥
- Long ìë£Œí˜•ì„ ê°–ê³  ìˆëŠ” Wrapping í´ë˜ìŠ¤

## ConcurrentHashMap

> HashMapì€ ë³´ì¡° í•´ì‹œ í•¨ìˆ˜(Additional Hash Function)ë¥¼ ì‚¬ìš©í•˜ê¸° ë•Œë¬¸ì— ë³´ì¡° í•´ì‹œ í•¨ìˆ˜ë¥¼ ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” HashTableì— ë¹„í•˜ì—¬ í•´ì‹œ ì¶©ëŒ(hash collision)ì´ ëœ ë°œìƒí•  ìˆ˜ ìˆìŒ
> 
- null í—ˆìš© X
- Thread-safeë¡œ êµ¬í˜„
- ì½ê¸° ì‘ì—…ì—ëŠ” ì—¬ëŸ¬ ì“°ë ˆë“œê°€ ë™ì‹œì— ì½ê¸° ê°€ëŠ¥
- ì“°ê¸° ì‘ì—…ì—ëŠ” íŠ¹ì • ì„¸ê·¸ë¨¼íŠ¸ / ë²„í‚·ì— ëŒ€í•œ Lockì„ ì‚¬ìš©
    - ê°™ì€ ë²„í‚·ë§Œ ì•„ë‹ˆë©´ Lockì„ ê¸°ë‹¤ë¦´ í•„ìš” X

<aside>
ğŸ’¡ ë™ì‹œì— ë°ì´í„°ë¥¼ ì‚½ì…, ì°¸ì¡°í•˜ë”ë¼ë„ ê·¸ ë°ì´í„°ê°€ ë‹¤ë¥¸ ì„¸ê·¸ë¨¼íŠ¸ì— ìœ„ì¹˜í•˜ë©´ ì„œë¡œ ë½ì„ ì–»ê¸° ìœ„í•´ ê²½ìŸì„ í•˜ì§€ ì•ŠìŒ

</aside>

# ì¶œì²˜

[https://devwithpug.github.io/java/java-thread-safe/](https://devwithpug.github.io/java/java-thread-safe/)

[https://bestugi.tistory.com/41](https://bestugi.tistory.com/41)